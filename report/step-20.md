## 토큰 발급 테스트

테스트 사용 툴 : Artillery

테스트 스크립트
```yaml
config:
  target: "http://localhost:3000"
  phases:
    - duration: 10
      arrivalRate: 1000
  defaults:
    headers:
      Content-Type: "application/json"
  payload:
    path: "../userId.csv"
    fields:
      - userId
    order: sequential

scenarios:
  - flow:
      - post:
          url: "/token/issue"
          json:
            userId: "{{ userId }}"

```

### 테스트 시나리오
- **1초동안 N명의 유저가 10초동안 토큰 발급을 요청한다**

### 테스트 결과 정리


### 1. 테스트 개요

| 테스트 케이스 | 총 요청 수 | 응답 코드 (201) | 실패 요청 | 요청 속도 (req/sec) |
|---------|--------|-------------|-------|-----------------|
| 200x10  | 2000   | 2000        | 0     | 205             |
| 400x10  | 4000   | 4000        | 0     | 312             |
| 600x10  | 6000   | 6000        | 0     | 545             |
| 800x10  | 8000   | 8000        | 0     | 471             |
| 1000x10 | 10000  | 10000       | 0     | 671             |

---

### 2. 응답 시간 분석 (ms)

| 테스트 케이스 | 최소 | p50 (중앙값) | p75    | p90    | p95    | p99    | 최대   |
|---------|----|-----------|--------|--------|--------|--------|------|
| 200x10  | 1  | 6         | 8.9    | 24.8   | 56.3   | 228.2  | 266  |
| 400x10  | 1  | 6         | 7.9    | 23.8   | 62.2   | 247.2  | 277  |
| 600x10  | 4  | 584.2     | 645.6  | 963.1  | 963.1  | 982.6  | 991  |
| 800x10  | 5  | 2893.5    | 3534.1 | 3905.8 | 3984.7 | 4065.2 | 4108 |
| 1000x10 | 67 | 6569.8    | 6838   | 6838   | 6976.1 | 6976.1 | 6984 |


### 3. VUser 세션 길이 분석 (ms)

| 테스트 케이스 | 최소   | p50 (중앙값) | p75    | p90    | p95    | p99    | 최대     |
|---------|------|-----------|--------|--------|--------|--------|--------|
| 200x10  | 2.2  | 7.2       | 10.7   | 30.9   | 68.7   | 232.8  | 267.8  |
| 400x10  | 1.7  | 6.8       | 9.9    | 25.8   | 63.4   | 247.2  | 279.4  |
| 600x10  | 5    | 584.2     | 645.6  | 963.1  | 963.1  | 982.6  | 992.5  |
| 800x10  | 6.5  | 2893.5    | 3534.1 | 3905.8 | 3984.7 | 4065.2 | 4108.3 |
| 1000x10 | 68.9 | 6569.8    | 6838   | 6838   | 6976.1 | 6976.1 | 6984.6 |


### 4. **분석 및 결론**

**성공률 100%**: 모든 요청이 정상적으로 처리됨 (`201 Created`)  
**요청 속도 증가**: 요청량이 많아질수록 초당 처리량도 증가 (최대 671 req/sec)  
**응답 시간 증가**: `600x10` 이후부터 `p50` 중앙값이 급격히 증가  
**문제점**: `800x10`, `1000x10` 테스트에서 응답 시간이 크게 증가

### 토큰 발급 성능 개선

#### Before

```typescript
const newToken = await this.tokenRepository.save({
  domain: TokenDomain.createWaitStatus({ userId, nowDate }),
  mgr,
});
```

#### After

```typescript
const newToken = TokenDomain.createWaitStatus({ userId, nowDate });
await this.tokenRepository.insert({
  domain: newToken,
  mgr,
});
```

- save를 insert로 변경해서 불필요한 select 쿼리 감소
- 커넥션풀 5개에서 30개로 변경

### 1. 테스트 개요

| 테스트 케이스    | 총 요청 수 | 응답 코드 (201) | 실패 요청      | 요청 속도 (req/sec) |
|------------|--------|-------------|------------|-----------------|
| 1000x10    | 10000  | 10000       | 0          | 671             |
| 1000x10-v2 | 10000  | 9999        | 1 (500 오류) | 1000            |

**개선 사항**

- **요청 속도**: **671 → 1000 req/sec (+49% 증가)**
- **성공률**: 99.99%로 유지 (1건의 500 오류 발생)


### 2. 응답 시간 비교 (ms)

| 테스트 케이스    | 최소 | p50 (중앙값) | p75    | p90    | p95    | p99    | 최대   |
|------------|----|-----------|--------|--------|--------|--------|------|
| 1000x10    | 67 | 6569.8    | 6838   | 6838   | 6976.1 | 6976.1 | 6984 |
| 1000x10-v2 | 6  | 4065.2    | 4583.6 | 4965.3 | 5065.6 | 5168   | 5152 |

**개선 사항**

- **응답 속도 대폭 감소**: `p50(중앙값)`이 **6569.8ms → 4065.2ms (-38%)**
- **최대 응답 시간**: **6984ms → 5152ms (-26%)**


### 3. VUser 세션 길이 비교 (ms)

| 테스트 케이스    | 최소   | p50 (중앙값) | p75    | p90    | p95    | p99    | 최대     |
|------------|------|-----------|--------|--------|--------|--------|--------|
| 1000x10    | 68.9 | 6569.8    | 6838   | 6838   | 6976.1 | 6976.1 | 6984.6 |
| 1000x10-v2 | 7.2  | 4065.2    | 4583.6 | 4965.3 | 5065.6 | 5168   | 5155.9 |

**개선 사항**

- **세션 길이 대폭 감소**: `p50(중앙값)`이 **6569.8ms → 4065.2ms (-38%)**
- **최대 세션 길이**: **6984.6ms → 5155.9ms (-26%)**


### 4. **최종 분석**

- **요청 속도 증가 (49%)** → 처리량 개선
- **응답 속도 단축 (38%)** → 평균 응답 시간 개선
- **최대 응답 시간 감소 (26%)** → 안정성 향상

---

## 좌석 점유 테스트

테스트 스크립트 : 
```yaml
config:
  target: "http://localhost:3000"
  phases:
    - duration: 1
      arrivalRate: 10000
  defaults:
    headers:
      Content-Type: "application/json"
  payload:
    path: "../userId.csv"
    fields:
      - userId
    order: sequential

scenarios:
  - flow:
      - post:
          url: "/concert/reservation"
          json:
            seatId: 1
            userId: "{{ userId }}"

```

**토큰 검증 로직을 제외하고 테스트를 진행**

### 테스트 시나리오
- **1초동안 N명의 하나의 좌석에 대해 예약 요청을 한다.**

### 1. 테스트 개요

| 테스트 케이스 | 총 요청 수 | 응답 코드 (201) | 응답 코드 (400) | 실패 요청 | 요청 속도 (req/sec) |
|---------|--------|-------------|-------------|-------|-----------------|
| 2000명   | 2000   | 1           | 1999        | 118   | 2208            |
| 4000    | 4000   | 1           | 3999        | 161   | 3810            |
| 6000    | 6000   | 1           | 5721        | 278   | 3419            |
| 8000    | 8006   | 1           | 5798        | 2207  | 2111            |
| 10000   | 10004  | 1           | 6664        | 3339  | 3809            |



### 2. 응답 시간 비교 (ms)

| 테스트 케이스 | 최소 | p50 (중앙값) | p75    | p90    | p95    | p99    | 최대   |
|---------|----|-----------|--------|--------|--------|--------|------|
| 2000    | 6  | 8.9       | 10.9   | 13.1   | 13.1   | 13.1   | 44   |
| 4000    | 5  | 1326.4    | 1495.5 | 1620   | 1652.8 | 1720.2 | 1735 |
| 6000    | 5  | 1465.9    | 1587.9 | 1755   | 1826.6 | 1901.1 | 1922 |
| 8000    | 5  | 1525.7    | 1587.9 | 1652.8 | 1686.1 | 1755   | 1814 |
| 10000   | 4  | 1408.4    | 2186.8 | 2276.1 | 2369   | 2369   | 2376 |



### 3. VUser 세션 길이 비교 (ms)

| 테스트 케이스 | 최소   | p50 (중앙값) | p75    | p90    | p95    | p99    | 최대     |
|---------|------|-----------|--------|--------|--------|--------|--------|
| 2000    | 14.5 | 19.1      | 22     | 24.8   | 24.8   | 24.8   | 61.9   |
| 4000    | 6    | 2231      | 2465.6 | 2671   | 2780   | 2893.5 | 3328.3 |
| 6000    | 6.8  | 2671      | 2951.9 | 3134.5 | 3328.3 | 3752.7 | 4027   |
| 8000    | 6.9  | 2836.2    | 3011.6 | 3011.6 | 3134.5 | 3464.1 | 3789.2 |
| 10000   | 13.4 | 2618.1    | 3395.5 | 3752.7 | 3752.7 | 3984.7 | 4114.4 |


### 4. **최종 분석**

- **201 요청이 1개이고 DB에서의 version 컬럼이 1 증가했으므로 동시성이슈 없이 요청을 처리한 것을 알 수 있음**
- 요청 속도 증가 후 8000명 이상부터 성능 저하

--- 



